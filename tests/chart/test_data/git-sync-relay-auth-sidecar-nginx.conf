pid /tmp/nginx.pid;
worker_processes 1;
events {
  multi_accept        on;
  worker_connections  3072;
  use                 epoll;
  }
http {
    
    proxy_temp_path /tmp/proxy_temp;
    client_body_temp_path /tmp/client_temp;
    fastcgi_temp_path /tmp/fastcgi_temp;
    uwsgi_temp_path /tmp/uwsgi_temp;
    scgi_temp_path /tmp/scgi_temp;
  
  proxy_cache_path /tmp/nginx-auth-cache levels=1:2 keys_zone=auth_cache:10m max_size=128m inactive=15m use_temp_path=off;

  upstream astro-gitsync-server {
    server 127.0.0.1:8000 ;
  }
  server {
    server_name release-name. ;
    listen 8084  ;
    
    # Disable Nginx Server version
    server_tokens off;
    client_max_body_size        1024m;
              
      proxy_cache auth_cache;
      proxy_cache_key "$http_cookie";
      proxy_cache_valid 200 15m, 401 403 1m;
      proxy_cache_methods GET HEAD;
      proxy_buffering on;
      proxy_set_header            Cookie                  $http_cookie;
    location ~ ^/release-name/git_sync/(webhook|healthz) {

      #proxy_set_header X-Original-URI        $request_uri;
      if ($host = '-airflow.' ) {
        return 308 https://deployments./release-name/git_sync/$request_uri;
      }

      # Custom headers to proxied server
      proxy_set_header  Host  deployments.;
      #proxy_set_header  X-Forwarded-Proto https;
      proxy_cookie_path                       off;
      rewrite ^/release-name/git_sync(.*)$ $1 break;
      proxy_pass http://astro-gitsync-server;

    }

    location /healthz {
      return 200;
    }

  }
}