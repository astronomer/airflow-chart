#!/bin/bash
set -e

# Common bash line that sets DIR to the directory of this script
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
# The path to the working directory - the root of the repo
REPO_DIR=$DIR/../

source $DIR/clean-slate

echo "Deploying Airflow..."

kubectl get pods -w &
WATCH_PID=$!

START=$(date +%s)

helm install \
  -n airflow \
  $REPO_DIR

HELM_CODE=$?
kill $WATCH_PID

# Output debugging information if the Helm install failed
if [ $HELM_CODE -eq 0 ]; then
  echo "Airflow deployed!"
else
  echo "Failed to deploy Airflow!"
  echo "Printing description and logs where containers in pod are not ready..."
  for pod in $(kubectl get pods | grep -v NAME | grep -v 1/1 | grep -v 2/2 | awk '{ print $1 }'); do
    echo "======================="
    set -x
    kubectl describe pod $pod
    kubectl logs $pod | tail -n 30
    set +x
    echo "======================="
  done
fi

set -x
kubectl get pods --all-namespaces
helm list

exit $HELM_CODE
