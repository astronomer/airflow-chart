######################################
## Logging sidecar configmap        ##
######################################
{{- if .Values.loggingSidecar.enabled }}
kind: ConfigMap
apiVersion: v1
metadata:
  name: sidecar-config
  labels:
    tier: airflow
    component: logging-sidecar
    release: {{ .Release.Name }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    heritage: {{ .Release.Service }}
data:
  vector-config.yaml: |
    data_dir : #{ENV['SIDECAR_LOGS_DIR']}
    sources:
      generate_syslog:
        type: file
        include:
          - #{ENV['SIDECAR_LOGS_DIR']}/*.log
        read_from: beginning
    sinks:
      out:
        type: elasticsearch
        inputs:
          - generate_syslog
        mode: bulk
        compression: none
      {{- if .Values.airflow.elasticsearch.enabled  }}
        endpoint: "http://{{ .Values.airflow.elasticsearch.connection.host }}:{{ .Values.airflow.elasticsearch.connection.port }}"
        auth:
          strategy: "basic"
          user: {{ .Values.airflow.elasticsearch.connection.user }}
          password : {{ .Values.airflow.elasticsearch.connection.password }}
      {{ else }}
      # TODO - confirm what needs to be done incase ES config disabled and not provided
      {{- end }}

{{- end }}
